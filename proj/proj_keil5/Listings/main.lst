C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: E:\Keil C51\C51\BIN\C51.EXE ..\src\main.c ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE INCDIR(..\include) 
                    -DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /**
   2           * main.c
   3           * ä½œè€…ï¼šæå®—éœ– æ—¥æœŸï¼š2023/12/01
   4           * CSDNæ˜µç§°ï¼šLeisure_æ°´ä¸­é±¼
   5           * CSDN: https://blog.csdn.net/Supine_0?type=blog
   6           * ----------------------------------------------
   7           * ç¨‹åºçš„main ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ† åˆå§‹åŒ–éƒ¨åˆ† ä¸»å¾ªç¯éƒ¨åˆ† ä¸­æ–­éƒ¨åˆ†
   8           */
   9          #include "__config__.h"
  10          #include "at24c02.h"
  11          #include "ds18b20.h"
  12          #include "i2c.h"
  13          #include "lcd1602.h"
  14          #include "ultimate.h"
  15          #include "utility.h"
  16          
  17          #define uint unsigned int
  18          #define uchar unsigned char
  19          
  20          sbit BUZZER = DEFINE_BUZZER; // èœ‚é¸£å™¨
  21          sbit RELAY = DEFINE_RELAY;   // ç»§ç”µå™¨
  22          sbit DCM = DEFINE_DCM;       // ç›´æµç”µæœº
  23          
  24          extern bit page_change;
  25          extern bit settings_mode;
  26          extern bit ready_settings;
  27          extern bit convert_finished;
  28          extern bit dc_motor_working;
  29          extern bit above_upper_limit;
  30          extern bit below_lower_limit;
  31          extern bit ringtone_change;
  32          extern bit save_in_24c02;
  33          extern bit play_music;
  34          
  35          extern float temperature, highest, lowest;
  36          extern uchar page, option, settingsSave;
  37          extern uchar hus, hms, hs, hm, lus, lms, ls, lm;
  38          extern uchar dsr, fanGear, fanGearStep;
  39          extern uchar ringRate, ringtoneNum;
  40          extern char upperLimit, lowerLimit;
  41          
  42          extern uint convertCount, dcmCount;
  43          extern uint SHOW_WAIT;
  44          
  45          extern uchar numStr[];
  46          extern uint code cttcn[];
  47          extern uint code FreqTable[];
  48          extern uchar idata musicArr[];
  49          extern uchar freqH, freqL, freqSelect;
  50          extern uint freqDelay, freqSize;
  51          
  52          void init_data(void);          // åˆå§‹åŒ–æ•°æ®
  53          void init_program(void);       // åˆå§‹åŒ–ç¨‹åº
  54          void UpdateTemperature(void);  // æ›´æ–°æ¸©åº¦ä¿¡æ¯
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 2   

  55          void UpdateViewPageShow(void); // åˆ·æ–°è§†å›¾æ˜¾ç¤º
  56          
  57          void main(void)
  58          {
  59   1          /**
  60   1           * åˆå§‹åŒ–æ•°æ®:
  61   1           * 1. åˆå§‹åŒ– å®šæ—¶/è®¡æ•°å™¨ å¯¹åº”çš„æ–¹å¼åˆå€¼ ä¼˜å…ˆçº§
  62   1           * 2. åˆå§‹åŒ– å¤–éƒ¨ä¸­æ–­ å¯¹åº”çš„æ–¹å¼ åˆå€¼ ä¼˜å…ˆçº§
  63   1           * 3. ä» DS18B20 è¯»å– æ¸©åº¦ä¸Šé™ ä¸‹é™ åˆ†è¾¨ç‡
  64   1           * 4. ä» 24LC02  è¯»å– ...
  65   1           */
  66   1          init_data();
  67   1      
  68   1          /**
  69   1           * åˆå§‹åŒ–ç¨‹åº:
  70   1           * 1. å¼€å§‹æ¸©åº¦è½¬æ¢
  71   1           * 2. LCD1602åˆå§‹åŒ– æ˜¾ç¤ºå¼€æœºç•Œé¢
  72   1           * 3. ä»¥æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºä¸»è§†å›¾
  73   1           * 4. æ‰“å¼€ å®šæ—¶/è®¡æ•°å™¨ä¸­æ–­ å¤–éƒ¨ä¸­æ–­
  74   1           */
  75   1          init_program();
  76   1          /**
  77   1           * ç¨‹åºçš„ä¸»å¾ªç¯:
  78   1           * 1. åˆ¤æ–­æ˜¯å“ªä¸€ç§æ¨¡å¼å¹¶æ‰§è¡Œæ¨¡å¼å¯¹åº”çš„ç¨‹åº
  79   1           * 2. æ¨¡å¼ä¸»ç¨‹åº:
  80   1           * - è®¾ç½®æ¨¡å¼
  81   1           *
  82   1           * - è§†å›¾æ¨¡å¼
  83   1           *   1. å¦‚æœæ¸©åº¦è½¬æ¢å®Œæˆ æ›´æ–°æ¸©åº¦ä¿¡æ¯
  84   1           *   2. åˆ¤æ–­å½“å‰å¤„äºå“ªä¸€ä¸ªè§†å›¾
  85   1           *   3. å¦‚æœè§†å›¾å‘ç”Ÿæ”¹å˜ éœ€è¦æ›´æ–°æ•´ä¸ªè§†å›¾
  86   1           *   4. å¦‚æœè§†å›¾æ²¡æœ‰æ”¹å˜ åˆ·æ–°å½“å‰è§†å›¾çš„ å¯å˜é‡
  87   1           *   5. ä»¥ æŒ‰é”®ç³»ç»Ÿ1 æ¥æ”¶æŒ‰é”®æ“ä½œ å¹¶ååº”
  88   1           *
  89   1           * å¤–éƒ¨ä¸­æ–­:
  90   1           * X0: é•¿æŒ‰åˆ‡æ¢è®¾ç½®æ¨¡å¼å’Œè§†å›¾æ¨¡å¼
  91   1           */
  92   1          while (1)
  93   1          {
  94   2              if (settings_mode) // è®¾ç½®æ¨¡å¼
  95   2              {
  96   3                  if (ready_settings)
  97   3                  {
  98   4                      ready_settings = 0;
  99   4                      ShowSettings(0); // æ˜¾ç¤ºè®¾ç½®æ¨¡å¼ å¹¶æŒ‡å‘ç¬¬ä¸€æ¡
 100   4                  }
 101   3                  KeysSystem_2(); // ç¬¬äºŒå¥—æŒ‰é”®äº‹ä»¶å“åº”ç³»ç»Ÿ
 102   3              }
 103   2              else // è§†å›¾æ¨¡å¼
 104   2              {
 105   3                  if (save_in_24c02)
 106   3                  {
 107   4                      save_in_24c02 = 0;
 108   4                      At24c02_WriteByte(0xa0, 0x00, &settingsSave, 1);
 109   4                  }
 110   3                  if (convert_finished)
 111   3                  { // å¦‚æœæ¸©åº¦è½¬æ¢å®Œæˆ æ›´æ–°æ¸©åº¦ä¿¡æ¯
 112   4                      UpdateTemperature();
 113   4                      convert_finished = 0;
 114   4                  }
 115   3                  UpdateViewPageShow(); // åˆ·æ–°è§†å›¾æ˜¾ç¤º
 116   3                  KeysSystem_1();       // ç¬¬ä¸€å¥—æŒ‰é”®äº‹ä»¶å“åº”ç³»ç»Ÿ
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 3   

 117   3              }
 118   2          }
 119   1      }
 120          
 121          void init_data(void)
 122          {
 123   1          EA = 0; // åˆå§‹åŒ–ä¸­æ–­ä¸ºå…³é—­
 124   1          ET0 = 0;
 125   1          ET1 = 0;
 126   1          TR0 = 0;
 127   1          TR1 = 0;
 128   1          EX0 = 0;
 129   1      
 130   1          DCM = 0;   // åˆå§‹åŒ–ç”µæœºä¸å·¥ä½œ
 131   1          RELAY = 0; // åˆå§‹åŒ–ç»§ç”µå™¨æ–­å¼€
 132   1      
 133   1          TMOD = 0x12; // å®šæ—¶å™¨0 æ–¹å¼2 å®šæ—¶å™¨1 æ–¹å¼1
 134   1          TH0 = 0x00;  // è‡ªåŠ¨è£…å¡«
 135   1          TL0 = 0x00;  // è®° 256 æ¬¡
 136   1          PT0 = 1;     // é«˜ä¼˜å…ˆçº§
 137   1          PT1 = 1;     // é«˜ä¼˜å…ˆçº§
 138   1      
 139   1          PX0 = 0; // ä½ä¼˜å…ˆçº§
 140   1          IT0 = 1; // ä¸‹é™æ²¿è§¦å‘
 141   1      
 142   1          // ä» DS18B20 è¯»å– æ¸©åº¦ä¸Šä¸‹é™ åˆ†è¾¨ç‡
 143   1          // DS18B20_Update();
 144   1          DS18B20_Get(&upperLimit, &lowerLimit, &dsr);
 145   1          // ä» 24c02 è¯»å– é£æ‰‡æ¡£ä½æ­¥é•¿ å¼€æœºéŸ³ä¹åºå· éŸ³é¢‘(åˆ†ä¸º0-7)
 146   1          // I2C_Init();
 147   1          At24c02_ReadData(0xa0, 0x00, &settingsSave, 1);
 148   1          ringRate = settingsSave & 0x07;
 149   1          ringtoneNum = (settingsSave >> 3) & 0x03;
 150   1          fanGearStep = (settingsSave >> 5) & 0x03;
 151   1          freqSize = 2144 - 256 * ringRate;
 152   1          // ä» 24c02 è¯»å– é“ƒå£° æ”¾å…¥ringtone
 153   1          ReadMusic();
 154   1      }
 155          
 156          void init_program(void)
 157          {
 158   1          DS18B20_Convert();                // å¼€å§‹æ¸©åº¦è½¬æ¢
 159   1          LCD1602_Action();                 // lcd1602 åˆå§‹åŒ–ï¼ˆå¼€æœºï¼‰
 160   1          UpdateTemperature();              // æ›´æ–°æ¸©åº¦ä¿¡æ¯
 161   1          LCD1602_WriteCmd(Show_CursorOn);  // æ‰“å¼€å…‰æ ‡
 162   1          SHOW_WAIT = 40;                   // å¼€æœºæ‰“å­—æœºç‰¹æ•ˆ
 163   1          ShowViewPage_1();                 // æ˜¾ç¤ºé¦–é¡µ
 164   1          LCD1602_WriteCmd(Show_CursorOff); // å…³é—­å…‰æ ‡
 165   1          SHOW_WAIT = 0;
 166   1          DS18B20_Convert();    // å¼€å§‹æ¸©åº¦è½¬æ¢
 167   1          convert_finished = 0; // æ‰“å¼€æ¸©åº¦è½¬æ¢å®šæ—¶
 168   1          EA = 1;               // æ€»ä¸­æ–­å…è®¸å¼€å¯
 169   1          ET0 = 1;              // å…è®¸å®šæ—¶å™¨ä¸­æ–­
 170   1          ET1 = 1;
 171   1          TR0 = 1; // T0 å¼€å§‹å·¥ä½œ
 172   1          TR1 = 0; // T1 ä¸å·¥ä½œ
 173   1          EX0 = 1; // å…è®¸å¤–éƒ¨ä¸­æ–­
 174   1      }
 175          
 176          void init_music(void)
 177          {
 178   1          play_music = 1;
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 4   

 179   1          PT0 = 0;
 180   1          TF1 = 0;    // æ¸…é™¤TF1æ ‡å¿—
 181   1          TH1 = 0xfc; // è®¾ç½®å®šæ—¶å™¨1åˆå€¼
 182   1          TL1 = 0x18;
 183   1          freqSelect = 0;
 184   1      }
 185          
 186          void UpdateTemperature(void)
 187          {
 188   1          uchar i;
 189   1          while (play_music && (freqDelay <= 24 || freqDelay >= 96))
 190   1              KeysSystem_1();
 191   1          EA = 0; // è·å–æ¸©åº¦è½¬åŒ–å¾—å…³é—­ä¸­æ–­ å¦åˆ™ä¼šç ´å DS18B20 çš„æ—¶åº é€ æˆé”™è¯¯
 192   1          temperature = DS18B20_ReadTemp(); // è·å–æ¸©åº¦è®¡è½¬æ¢çš„æ¸©åº¦
 193   1          DS18B20_Convert();
 194   1          i = 35;
 195   1          do
 196   1          {
 197   2          } while (--i); // 85ä¸ªæœºå™¨å‘¨æœŸ å…±çº¦ 2+1+5815+70 ä¸ªæœºå™¨å‘¨æœŸ
 198   1          EA = 1; // å‡è®¾è§¦å‘å®šæ—¶ä¸­æ–­ 23 æ¬¡ å¯èƒ½æœ‰ä¸€äº›è¯¯å·® ä½†éå¸¸å°
 199   1          if (play_music)
 200   1              freqDelay -= 23;
 201   1          temperature *= 0.0625; // è½¬åŒ–ä¸ºå¯è¯»æ¸©åº¦
 202   1          // æ›´æ–°æ¸©åº¦æœ€å¤§æœ€å°å€¼
 203   1          if (temperature > highest)
 204   1              highest = temperature;
 205   1          if (temperature < lowest)
 206   1              lowest = temperature;
 207   1          // æ¯”è¾ƒæ¸©åº¦æ˜¯å¦è¶Šç•Œ å¹¶é‡‡å–æªæ–½
 208   1          if (temperature > upperLimit) // é«˜äºæ¸©åº¦ä¸Šé™
 209   1          {
 210   2              above_upper_limit = 1; // è®¾ç½®ä¸Šè¶Šç•Œæ ‡å¿—ä½
 211   2              dc_motor_working = 1;  // ç›´æµç”µæœºå¼€å§‹å·¥ä½œ
 212   2              fanGear = (temperature - upperLimit) / fanGearStep + 1;
 213   2              if (fanGear > 3)
 214   2                  fanGear = 3;
 215   2              i = 23;
 216   2              do
 217   2              {
 218   3                  AboveLimitClock(); // ä¸Šè¶Šç•Œå®šæ—¶
 219   3              } while (--i);
 220   2              if (!play_music)
 221   2                  init_music();
 222   2          }
 223   1          else if (temperature < lowerLimit) // ä½äºæ¸©åº¦ä¸‹é™
 224   1          {
 225   2              below_lower_limit = 1; // è®¾ç½®ä¸‹è¶Šç•Œæ ‡å¿—ä½
 226   2              RELAY = 1;             // é—­åˆç»§ç”µå™¨
 227   2              i = 21;
 228   2              do
 229   2              {
 230   3                  BelowLimitClock(); // ä¸‹è¶Šç•Œå®šæ—¶
 231   3              } while (--i);
 232   2              if (!play_music)
 233   2                  init_music();
 234   2          }
 235   1          else // æ¸©åº¦æ­£å¸¸
 236   1          {
 237   2              BUZZER = 1;
 238   2              RELAY = 0;             // æ–­å¼€ç»§ç”µå™¨
 239   2              dc_motor_working = 0;  // ç›´æµç”µæœºåœæ­¢å·¥ä½œ
 240   2              fanGear = 0;           // ç›´æµç”µæœºæ¡£ä½ç½®0
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 5   

 241   2              below_lower_limit = 0; // ä¸‹è¶Šç•Œæ ‡å¿—ä½æ¸…0
 242   2              above_upper_limit = 0; // ä¸Šè¶Šç•Œæ ‡å¿—ä½æ¸…0
 243   2              PT0 = 1;
 244   2              TR1 = 0;
 245   2              play_music = 0;
 246   2          }
 247   1      }
 248          
 249          void UpdateViewPageShow(void)
 250          {
 251   1          switch (page) // åˆ¤æ–­å½“å‰å¤„äºå“ªä¸€ä¸ªè§†å›¾
 252   1          {
 253   2          case 0x7f: // ä¸»è§†å›¾ (æ¸©åº¦ä¿¡æ¯æŸ¥è¯¢è§†å›¾)
 254   2              if (page_change)
 255   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 256   3                  ShowViewPage_1();
 257   3                  page_change = 0;
 258   3              }
 259   2              // åˆ·æ–°æ¸©åº¦å€¼æ˜¾ç¤º
 260   2              LCD1602_WriteCmd(Move_Cursor_Row2_Col(2));
 261   2              FloatToString(temperature, numStr, 5, 1);
 262   2              LCD1602_ShowString(numStr);
 263   2              // åˆ·æ–°é£æ‰‡æ¡£ä½æ˜¾ç¤º
 264   2              LCD1602_WriteCmd(Move_Cursor_Row2_Col(15));
 265   2              Int8ToString(fanGear, numStr, 1);
 266   2              LCD1602_ShowString(numStr);
 267   2              break;
 268   2          case 0xbf: // æœ€é«˜/æœ€ä½æ¸©(æ¸©åº¦æå€¼)æŸ¥è¯¢è§†å›¾
 269   2              if (page_change)
 270   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 271   3                  ShowViewPage_2();
 272   3                  page_change = 0;
 273   3              }
 274   2              // åˆ·æ–°æ˜¾ç¤ºæ¸©åº¦çš„æå€¼
 275   2              LCD1602_WriteCmd(Move_Cursor_Row1_Col(9));
 276   2              UpdateExtremes(1);
 277   2              LCD1602_WriteCmd(Move_Cursor_Row2_Col(9));
 278   2              UpdateExtremes(0);
 279   2              break;
 280   2          case 0xdf: // æ¸©åº¦è¶Šç•Œè®¡æ—¶è§†å›¾
 281   2              if (page_change)
 282   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 283   3                  ShowViewPage_3();
 284   3                  page_change = 0;
 285   3              }
 286   2              // å¦‚æœæ¸©åº¦é«˜äºä¸Šé™ åˆ·æ–°æ˜¾ç¤ºä¸Šè¶Šç•Œè®¡æ—¶
 287   2              if (above_upper_limit)
 288   2              {
 289   3                  LCD1602_WriteCmd(Move_Cursor_Row1_Col(8));
 290   3                  UpdateOverLimitTimer(1);
 291   3              }
 292   2              // å¦‚æœæ¸©åº¦ä½äºä¸‹é™ åˆ·æ–°æ˜¾ç¤ºä¸‹è¶Šç•Œè®¡æ—¶
 293   2              else if (below_lower_limit)
 294   2              {
 295   3                  LCD1602_WriteCmd(Move_Cursor_Row2_Col(8));
 296   3                  UpdateOverLimitTimer(0);
 297   3              }
 298   2      
 299   2          case 0xef: // è®¾ç½®æŸ¥è¯¢è§†å›¾
 300   2              if (page_change)
 301   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 302   3                  ShowViewPage_4();
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 6   

 303   3                  page_change = 0;
 304   3              }
 305   2              // æ²¡æœ‰éœ€è¦åˆ·æ–°çš„å¯å˜é‡
 306   2              break;
 307   2          }
 308   1      }
 309          
 310          void UpdateAboutTimer(void)
 311          {
 312   1          // æ ¹æ®åˆ†è¾¨ç‡è°ƒæ•´æ¸©åº¦è½¬æ¢éœ€è¦çš„æ—¶é—´
 313   1          if (!convert_finished && ++convertCount >= cttcn[dsr])
 314   1          {
 315   2              convertCount = 0;
 316   2              convert_finished = 1;
 317   2          }
 318   1          // å°†ç›´æµç”µæœºçš„æ–¹æ³¢åˆ†æˆ 3æ®µ æ ¹æ®æ¡£ä½å†³å®šæŸä¸€æ®µ ç”µå¹³é«˜ä½
 319   1          if (dc_motor_working)
 320   1          {
 321   2              if (++dcmCount >= 1440)       // 0.4s
 322   2                  if (dcmCount >= 2520)     // 0.7s
 323   2                      if (dcmCount >= 3600) // 1.0s
 324   2                          dcmCount = 0;
 325   2                      else // 0.7s - 1.0s
 326   2                          DCM = fanGear >= 0x03;
 327   2                  else // 0.4s - 0.7s
 328   2                      DCM = fanGear >= 0x02;
 329   2              else // 0.0s - 0.4s
 330   2                  DCM = fanGear >= 0x01;
 331   2          }
 332   1          else
 333   1              DCM = 0;
 334   1          // è¿‡ç•Œå®šæ—¶ éœ€è¦ 32ä¸ªæœºå™¨å‘¨æœŸ
 335   1          if (above_upper_limit)
 336   1              AboveLimitClock();
 337   1          else if (below_lower_limit)
 338   1              BelowLimitClock();
 339   1      
 340   1          if (play_music)
 341   1              if (--freqDelay == 96)
 342   1                  TR1 = 0;
 343   1              else if (!freqDelay)
 344   1              {
 345   2                  TR1 = 1;
 346   2                  if (musicArr[freqSelect] == 0xff)
 347   2                      freqSelect = 0;
 348   2                  freqH = FreqTable[musicArr[freqSelect]] >> 8;
 349   2                  freqL = FreqTable[musicArr[freqSelect]] & 0xff;
 350   2                  ++freqSelect;
 351   2                  freqDelay = freqSize * musicArr[freqSelect]; // é€‰æ‹©éŸ³ç¬¦å¯¹åº”çš„æ—¶é•¿
 352   2                  ++freqSelect;
 353   2              }
 354   1      }
 355          
 356          /**
 357           * X0 ä¸­æ–­å‡½æ•°
 358           * è®¾å®š:
 359           *     å¤–éƒ¨ä¸­æ–­0 ä¸ºä½ä¼˜å…ˆçº§ å¯ä»¥è¢«å®šæ—¶å™¨ä¸­æ–­ ç»™ä¸­æ–­
 360           *     å¦åˆ™ å¤–éƒ¨ä¸­æ–­ä¼šç ´å T0 äº§ç”Ÿçš„æ—¶åº
 361           *     è®¾ç½®æ¨¡å¼ä¸‹ä¼šå…³é—­å®šæ—¶å™¨ å› ä¸ºæ²¡æœ‰ç»§ç»­å®šæ—¶çš„å¿…è¦
 362           * æ€è·¯:
 363           *     å¤–éƒ¨ä¸­æ–­é€šè¿‡è½¯ä»¶å»¶è¿Ÿ æ¯0.05såˆ¤æ–­ä¸€æ¬¡æ˜¯å¦ä»ç„¶å¤„äº æŒ‰ä¸‹ä¸”ä»…æŒ‰ä¸‹ INT0
 364           çŠ¶æ€
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 7   

 365           *     å½“æŒ‰ä¸‹æŒç»­æ—¶é—´è¶…è¿‡ç»™å®šé˜ˆå€¼å°†ä¼š åˆ‡æ¢è®¾ç½®/è§†å›¾æ¨¡å¼ å¹¶æ‰§è¡Œå¿…è¦çš„
 366           åˆå§‹åŒ–/æ”¶å°¾
 367           * å·¥ä½œ
 368           */
 369          void int_X0() interrupt 0
 370          {
 371   1          uchar ky; // ä¸´æ—¶ç”¨æ¥æ¥æ”¶æŒ‰é”®æ“ä½œ
 372   1          uchar i = 20;
 373   1          KEYS = 0xff;
 374   1          do
 375   1          {
 376   2              ky = 0x03;
 377   2              ky |= KEYS;
 378   2              if (ky != 0xfb)
 379   2              {
 380   3                  Delay1ms(10);
 381   3                  ky = 0x03;
 382   3                  ky |= KEYS;
 383   3                  if (ky != 0xfb)
 384   3                      return;
 385   3              }
 386   2              Delay1ms(50);
 387   2          } while (--i);
 388   1          if (settings_mode) // é€€å‡ºè®¾ç½®æ¨¡å¼
 389   1          {
 390   2              // å°†è®¾ç½®çš„å†…å®¹å­˜å‚¨è‡³ DS18B20
 391   2              DS18B20_Set(upperLimit, lowerLimit, dsr);
 392   2              DS18B20_Save();
 393   2              // å°†è®¾ç½®çš„å†…å®¹å­˜å‚¨è‡³ 24lc02
 394   2              settingsSave = 0xff;
 395   2              settingsSave &= (fanGearStep << 5) | (ringtoneNum << 3) | (ringRate);
 396   2              if (ringtone_change)
 397   2                  ReadMusic();
 398   2              /**
 399   2               * @bug ä¸çŸ¥é“ä¸ºä»€ä¹ˆ åªè¦åœ¨æ­¤æ”¾ä¸‹
 400   2               * AT24C02_WriteData(0xa0,0x00,&settingsSave,1) / Byte(...)
 401   2               * å°±ä¼šåœ¨è§¦å‘å¤–éƒ¨ä¸­æ–­æ—¶å¯¼è‡´æ­»å¾ªç¯/å´©æºƒï¼Œå“ªæ€• if(0)
 402   2               * æ²¡æœ‰è°ƒç”¨æ­¤å‡½æ•° ä»…ä»…æ˜¯å­˜åœ¨å°±ä¼šå¯¼è‡´å¦‚æ­¤ å› æ­¤ä½œä¸ºå¦¥å
 403   2               åªå¥½è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½
 404   2               * åœ¨ä¸»å¾ªç¯ä¸­è¿›è¡Œå­˜å‚¨
 405   2               */
 406   2              save_in_24c02 = 1;
 407   2              // ... ...
 408   2              DS18B20_Convert();
 409   2              convertCount = 0;
 410   2              convert_finished = 0; // é‡æ–°æ‰“å¼€æ¸©åº¦è½¬æ¢
 411   2              TR0 = 1;              // é‡å¯å®šæ—¶å™¨å¼€å§‹æµ‹æ¸©
 412   2              freqSize = 2144 - 256 * ringRate;
 413   2              option = 0xff;        // è®¾ç½®æ¨¡å¼ ä¸é€‰æ‹©
 414   2              page_change = 1;      // éœ€è¦åˆ·æ–°æ•´ä¸ªè§†å›¾æ˜¾ç¤º
 415   2          }
 416   1          else // è¿›å…¥è®¾ç½®æ¨¡å¼
 417   1          {
 418   2              RELAY = 0; // æ–­å¼€ç»§ç”µå™¨
 419   2              DCM = 0;   // å…³é—­ç›´æµç”µæœº
 420   2              TR0 = 0;   // å…³é—­å®šæ—¶è®¡å™¨T0
 421   2              TR1 = 0;   // å…³é—­å®šæ—¶è®¡å™¨T1
 422   2              play_music = 0; // å…³é—­éŸ³ä¹
 423   2              // å¾—ä»ä¸»å‡½æ•°ä¸­è°ƒç”¨ å¦åˆ™å¯èƒ½ä¼šå‘ç”Ÿå½¢å‚è¢«å‡ºé”™ äº§ç”Ÿä¸å¯é¢„æ–™é—®é¢˜
 424   2              // å¯ä»¥è®¾å®šä¸€ä¸ªæ ‡å¿— è®©ä¸»å‡½æ•°è°ƒç”¨ä¸€æ¬¡ ready_settings
 425   2              ready_settings = 1; // è¿›å…¥è®¾ç½®æ¨¡å¼ åˆ·æ–°è®¾ç½®æ¨¡å¼æ˜¾ç¤º
 426   2          }
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 8   

 427   1          settings_mode = !settings_mode;
 428   1      }
 429          
 430          /**
 431           * T0 ä¸­æ–­å‡½æ•°
 432           * è®¾å®š:
 433           *     å®šæ—¶å™¨ T0 æ–¹å¼2 åˆå€¼ 0 è®¡æ•°256æº¢å‡ºä¸€æ¬¡
 434           *     æ‰€ä»¥ å®šæ—¶å™¨ä¸­æ–­å†… æŒ‡ä»¤å‘¨æœŸæ€»å’Œéœ€è¦å°‘äº 250 ä¸ªæœºå™¨å‘¨æœŸ
 435           *     åœ¨ å®šæ—¶å™¨ä¸­æ–­å‡½æ•°å†… è·å–æ¸©åº¦ç­‰å¤æ‚å‡½æ•° ä¼šä¸¥é‡ç ´å T0 äº§ç”Ÿçš„æ—¶åº
 436           * æ€è·¯:
 437           *     åœ¨ä¸­æ–­å‡½æ•°å†…é€šè¿‡è®¾ç½®æ ‡å¿—ä½ è®©å¤æ‚çš„å‡½æ•°é€»è¾‘åœ¨ä¸»å¾ªç¯ä¸­æ‰§è¡Œ
 438           * ç†å¿µ:
 439           *     åœ¨ 11.0592MHzä¸‹  æ¯ 1/3.6 ms æº¢å‡ºä¸€æ¬¡ å³ä¸­æ–­36æ¬¡ä¸º 10ms
 440           *     æ‰€ä»¥ T0 å¯ä»¥ä½œä¸º 1/3.6 ms çš„æ—¶åºäº§ç”Ÿå™¨
 441           *     é€šè¿‡ è®¡æ•°å˜é‡ count å³å¯å®ç°ä¸åŒå‘¨æœŸçš„å®šæ—¶
 442           */
 443          void int_T0() interrupt 1 using 1 // æŒ‡å®šå¯„å­˜å™¨ç»„æé«˜ç¨‹åºæ•ˆç‡ å‡å°‘è¯¯å·®
 444          {
 445   1          UpdateAboutTimer();
 446   1      }
 447          
 448          void int_T1() interrupt 3 using 2 // æŒ‡å®šå¯„å­˜å™¨ç»„æé«˜ç¨‹åºæ•ˆç‡ å‡å°‘è¯¯å·®
 449          {
 450   1          if (freqH || freqL) // å¦‚æœæ˜¯ä¼‘æ­¢ç¬¦(0)ï¼Œé‚£ä¹ˆä¸æ’­æ”¾å£°éŸ³ï¼Œåªè¿›è¡Œå»¶æ—¶
 451   1          {
 452   2              // å–å¯¹åº”é¢‘ç‡å€¼çš„é‡è£…è½½å€¼åˆ°å®šæ—¶å™¨(ç¡®è®¤éŸ³é«˜) musicArr[musicSelect]
 453   2              TH1 = freqH; // è®¾ç½®é«˜ä½å®šæ—¶åˆå€¼
 454   2              TL1 = freqL; // è®¾ç½®ä½ä½å®šæ—¶åˆå€¼
 455   2              // ç¿»è½¬èœ‚é¸£å™¨IOå£(æ³¨æ„è¿™é‡Œçš„é‡è£…å€¼æ˜¯å‘¨æœŸçš„ä¸€åŠï¼Œæ•…ä»…è¿›è¡Œä¸€æ¬¡èœ‚é¸£å™¨çš
             -„ç¿»è½¬)
 456   2              BUZZER = !BUZZER;
 457   2          }
 458   1          if (TF0)
 459   1          {
 460   2              TF0 = 0;
 461   2              UpdateAboutTimer();
 462   2          }
 463   1      }
 464          
 465          /*
 466           * ä¸ºäº†æµ‹æ—¶I2C 24C02
 467          extern void _nop_(void);
 468          uchar code aa[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
 469          uchar idata bb[] = "                                                        ";
 470          extern void Delay1ms(uint t);
 471          extern uint SHOW_WAIT;
 472          
 473          void main(void)
 474          {
 475              uchar i, j;
 476              LCD1602_WriteCmd(Set_8bit_2line_5x7); // å‘½ä»¤6
 477              LCD1602_WriteCmd(Show_CursorOn);      // å‘½ä»¤4
 478              LCD1602_WriteCmd(Mode_CursorRightMove);
 479              LCD1602_WriteCmd(Clear_Screen); // å‘½ä»¤1
 480              // I2C_WriteData(0xa0, 0x00, aa, 26);
 481              I2C_Init();
 482              // I2C_WriteData(0xa0, 0x80, aa, 53);
 483              // At24c02_WriteByte(0xa0, 0x00, aa, 8);
 484              At24c02_WriteData(0xa0, 0xb0, aa, 53);
 485              SHOW_WAIT = 100;
 486          
 487              // LCD1602_ShowString(aa);
C51 COMPILER V9.60.7.0   MAIN                                                              12/06/2023 11:46:53 PAGE 9   

 488              At24c02_ReadData(0xa0, 0xb0, bb, 53);
 489              i = 53;
 490              while (1)
 491              {
 492                  LCD1602_WriteCmd(Move_Cursor_Row1_Col(0));
 493                  for (j = 16; j && i; --j)
 494                  {
 495                      LCD1602_WriteData(bb[--i]);
 496                      Delay1ms(100);
 497                  }
 498                  if (!i)
 499                      break;
 500              }
 501              // // LCD1602_WriteCmd(Return_Cursor);
 502              // // LCD1602_WriteCmd(Move_Cursor_Row2_Col(15));
 503              // // LCD1602_ShowString(bb);
 504              while (1)
 505                  ;
 506          }
 507          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1279    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
