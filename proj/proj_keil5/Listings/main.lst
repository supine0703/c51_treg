C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: E:\Keil C51\C51\BIN\C51.EXE ..\src\main.c ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE INCDIR(..\include) 
                    -DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /**
   2           * main.c
   3           * ä½œè€…ï¼šæå®—éœ– æ—¥æœŸï¼š2023/12/01
   4           * CSDNæ˜µç§°ï¼šLeisure_æ°´ä¸­é±¼
   5           * CSDN: https://blog.csdn.net/Supine_0?type=blog
   6           * ----------------------------------------------
   7           * ç¨‹åºçš„main ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ† åˆå§‹åŒ–éƒ¨åˆ† ä¸»å¾ªç¯éƒ¨åˆ† ä¸­æ–­éƒ¨åˆ†
   8           */
   9          #include "__config__.h"
  10          #include "at24c02.h"
  11          #include "ds18b20.h"
  12          #include "i2c.h"
  13          #include "lcd1602.h"
  14          #include "ultimate.h"
  15          #include "utility.h"
  16          
  17          #define uint unsigned int
  18          #define uchar unsigned char
  19          
  20          sbit BUZZER = DEFINE_BUZZER; // èœ‚é¸£å™¨
  21          sbit RELAY = DEFINE_RELAY;   // ç»§ç”µå™¨
  22          sbit DCM = DEFINE_DCM;       // ç›´æµç”µæœº
  23          
  24          extern bit page_change;
  25          extern bit settings_mode;
  26          extern bit ready_settings;
  27          extern bit convert_finished;
  28          extern bit dc_motor_working;
  29          extern bit above_upper_limit;
  30          extern bit below_lower_limit;
  31          extern bit ringtone_change;
  32          extern bit save_in_24c02;
  33          extern bit play_music;
  34          
  35          extern float temperature, highest, lowest;
  36          extern uchar page, option, settingsSave;
  37          extern uchar hus, hms, hs, hm, lus, lms, ls, lm;
  38          extern uchar dsr, fanGear, fanGearStep;
  39          extern uchar ringRate, ringtoneNum;
  40          extern char upperLimit, lowerLimit;
  41          
  42          extern uint convertCount, dcmCount;
  43          extern uint SHOW_WAIT;
  44          
  45          extern uchar numStr[];
  46          extern uint code cttcn[];
  47          extern uint code FreqTable[];
  48          extern uchar idata musicArr[];
  49          extern uchar freqH, freqL, freqSelect;
  50          extern uint freqDelay, freqSize;
  51          
  52          void init_data(void);          // åˆå§‹åŒ–æ•°æ®
  53          void init_program(void);       // åˆå§‹åŒ–ç¨‹åº
  54          void UpdateTemperature(void);  // æ›´æ–°æ¸©åº¦ä¿¡æ¯
C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 2   

  55          void UpdateViewPageShow(void); // åˆ·æ–°è§†å›¾æ˜¾ç¤º
  56          
  57          void main(void)
  58          {
  59   1          /**
  60   1           * åˆå§‹åŒ–æ•°æ®:
  61   1           * 1. åˆå§‹åŒ– å®šæ—¶/è®¡æ•°å™¨ å¯¹åº”çš„æ–¹å¼åˆå€¼ ä¼˜å…ˆçº§
  62   1           * 2. åˆå§‹åŒ– å¤–éƒ¨ä¸­æ–­ å¯¹åº”çš„æ–¹å¼ åˆå€¼ ä¼˜å…ˆçº§
  63   1           * 3. ä» DS18B20 è¯»å– æ¸©åº¦ä¸Šé™ ä¸‹é™ åˆ†è¾¨ç‡
  64   1           * 4. ä» 24LC02  è¯»å– ...
  65   1           */
  66   1          init_data();
  67   1      
  68   1          /**
  69   1           * åˆå§‹åŒ–ç¨‹åº:
  70   1           * 1. å¼€å§‹æ¸©åº¦è½¬æ¢
  71   1           * 2. LCD1602åˆå§‹åŒ– æ˜¾ç¤ºå¼€æœºç•Œé¢
  72   1           * 3. ä»¥æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºä¸»è§†å›¾
  73   1           * 4. æ‰“å¼€ å®šæ—¶/è®¡æ•°å™¨ä¸­æ–­ å¤–éƒ¨ä¸­æ–­
  74   1           */
  75   1          init_program();
  76   1          /**
  77   1           * ç¨‹åºçš„ä¸»å¾ªç¯:
  78   1           * 1. åˆ¤æ–­æ˜¯å“ªä¸€ç§æ¨¡å¼å¹¶æ‰§è¡Œæ¨¡å¼å¯¹åº”çš„ç¨‹åº
  79   1           * 2. æ¨¡å¼ä¸»ç¨‹åº:
  80   1           * - è®¾ç½®æ¨¡å¼
  81   1           *
  82   1           * - è§†å›¾æ¨¡å¼
  83   1           *   1. å¦‚æœæ¸©åº¦è½¬æ¢å®Œæˆ æ›´æ–°æ¸©åº¦ä¿¡æ¯
  84   1           *   2. åˆ¤æ–­å½“å‰å¤„äºå“ªä¸€ä¸ªè§†å›¾
  85   1           *   3. å¦‚æœè§†å›¾å‘ç”Ÿæ”¹å˜ éœ€è¦æ›´æ–°æ•´ä¸ªè§†å›¾
  86   1           *   4. å¦‚æœè§†å›¾æ²¡æœ‰æ”¹å˜ åˆ·æ–°å½“å‰è§†å›¾çš„ å¯å˜é‡
  87   1           *   5. ä»¥ æŒ‰é”®ç³»ç»Ÿ1 æ¥æ”¶æŒ‰é”®æ“ä½œ å¹¶ååº”
  88   1           *
  89   1           * å¤–éƒ¨ä¸­æ–­:
  90   1           * X0: é•¿æŒ‰åˆ‡æ¢è®¾ç½®æ¨¡å¼å’Œè§†å›¾æ¨¡å¼
  91   1           */
  92   1          while (1)
  93   1          {
  94   2              if (settings_mode) // è®¾ç½®æ¨¡å¼
  95   2              {
  96   3                  if (ready_settings)
  97   3                  {
  98   4                      ready_settings = 0;
  99   4                      ShowSettings(0); // æ˜¾ç¤ºè®¾ç½®æ¨¡å¼ å¹¶æŒ‡å‘ç¬¬ä¸€æ¡
 100   4                  }
 101   3                  KeysSystem_2(); // ç¬¬äºŒå¥—æŒ‰é”®äº‹ä»¶å“åº”ç³»ç»Ÿ
 102   3              }
 103   2              else // è§†å›¾æ¨¡å¼
 104   2              {
 105   3                  if (save_in_24c02)
 106   3                  {
 107   4                      save_in_24c02 = 0;
 108   4                      At24c02_WriteByte(0xa0, 0x00, &settingsSave, 1);
 109   4                  }
 110   3                  if (convert_finished)
 111   3                  { // å¦‚æœæ¸©åº¦è½¬æ¢å®Œæˆ æ›´æ–°æ¸©åº¦ä¿¡æ¯
 112   4                      UpdateTemperature();
 113   4                      convert_finished = 0;
 114   4                  }
 115   3                  UpdateViewPageShow(); // åˆ·æ–°è§†å›¾æ˜¾ç¤º
 116   3                  KeysSystem_1();       // ç¬¬ä¸€å¥—æŒ‰é”®äº‹ä»¶å“åº”ç³»ç»Ÿ
C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 3   

 117   3              }
 118   2          }
 119   1      }
 120          
 121          void init_data(void)
 122          {
 123   1          EA = 0; // åˆå§‹åŒ–ä¸­æ–­ä¸ºå…³é—­
 124   1          ET0 = 0;
 125   1          ET1 = 0;
 126   1          TR0 = 0;
 127   1          TR1 = 0;
 128   1          EX0 = 0;
 129   1      
 130   1          DCM = 0;   // åˆå§‹åŒ–ç”µæœºä¸å·¥ä½œ
 131   1          RELAY = 0; // åˆå§‹åŒ–ç»§ç”µå™¨æ–­å¼€
 132   1      
 133   1          TMOD = 0x12; // å®šæ—¶å™¨0 æ–¹å¼2 å®šæ—¶å™¨1 æ–¹å¼1
 134   1          TH0 = 0x00;  // è‡ªåŠ¨è£…å¡«
 135   1          TL0 = 0x00;  // è®° 256 æ¬¡
 136   1          PT0 = 1;     // é«˜ä¼˜å…ˆçº§
 137   1          PT1 = 1;     // é«˜ä¼˜å…ˆçº§
 138   1      
 139   1          PX0 = 0; // ä½ä¼˜å…ˆçº§
 140   1          IT0 = 1; // ä¸‹é™æ²¿è§¦å‘
 141   1      
 142   1          // ä» DS18B20 è¯»å– æ¸©åº¦ä¸Šä¸‹é™ åˆ†è¾¨ç‡
 143   1          // DS18B20_Update();
 144   1          DS18B20_Get(&upperLimit, &lowerLimit, &dsr);
 145   1          // ä» 24c02 è¯»å– é£æ‰‡æ¡£ä½æ­¥é•¿ å¼€æœºéŸ³ä¹åºå· éŸ³é¢‘(åˆ†ä¸º0-7)
 146   1          // I2C_Init();
 147   1          At24c02_ReadData(0xa0, 0x00, &settingsSave, 1);
 148   1          ringRate = settingsSave & 0x07;
 149   1          ringtoneNum = (settingsSave >> 3) & 0x03;
 150   1          fanGearStep = (settingsSave >> 5) & 0x03;
 151   1          freqSize = 2144 - 256 * ringRate;
 152   1          // ä» 24c02 è¯»å– é“ƒå£° æ”¾å…¥ringtone
 153   1          ReadMusic();
 154   1      }
 155          
 156          void init_program(void)
 157          {
 158   1          DS18B20_Convert();                // å¼€å§‹æ¸©åº¦è½¬æ¢
 159   1          LCD1602_Action();                 // lcd1602 åˆå§‹åŒ–ï¼ˆå¼€æœºï¼‰
 160   1          UpdateTemperature();              // æ›´æ–°æ¸©åº¦ä¿¡æ¯
 161   1          LCD1602_WriteCmd(Show_CursorOn);  // æ‰“å¼€å…‰æ ‡
 162   1          SHOW_WAIT = 40;                   // å¼€æœºæ‰“å­—æœºç‰¹æ•ˆ
 163   1          ShowViewPage_1();                 // æ˜¾ç¤ºé¦–é¡µ
 164   1          LCD1602_WriteCmd(Show_CursorOff); // å…³é—­å…‰æ ‡
 165   1          SHOW_WAIT = 0;
 166   1          DS18B20_Convert();    // å¼€å§‹æ¸©åº¦è½¬æ¢
 167   1          convert_finished = 0; // æ‰“å¼€æ¸©åº¦è½¬æ¢å®šæ—¶
 168   1          EA = 1;               // æ€»ä¸­æ–­å…è®¸å¼€å¯
 169   1          ET0 = 1;              // å…è®¸å®šæ—¶å™¨ä¸­æ–­
 170   1          ET1 = 1;
 171   1          TR0 = 1; // T0 å¼€å§‹å·¥ä½œ
 172   1          TR1 = 0; // T1 ä¸å·¥ä½œ
 173   1          EX0 = 1; // å…è®¸å¤–éƒ¨ä¸­æ–­
 174   1      }
 175          
 176          void init_music(void)
 177          {
 178   1          play_music = 1;
C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 4   

 179   1          PT0 = 0;
 180   1          TF1 = 0;    // æ¸…é™¤TF1æ ‡å¿—
 181   1          TH1 = 0xfc; // è®¾ç½®å®šæ—¶å™¨1åˆå€¼
 182   1          TL1 = 0x18;
 183   1          freqSelect = 0;
 184   1      }
 185          
 186          void UpdateTemperature(void)
 187          {
 188   1          uchar i;
 189   1          while (play_music && (freqDelay <= 24 || freqDelay >= 96))
 190   1          {
 191   2              KeysSystem_1();
 192   2              if (page_change)
 193   2                  UpdateViewPageShow();
 194   2          }
 195   1          TR0 = 0;
 196   1          EA = 0; // è·å–æ¸©åº¦è½¬åŒ–å¾—å…³é—­ä¸­æ–­ å¦åˆ™ä¼šç ´å DS18B20 çš„æ—¶åº é€ æˆé”™è¯¯
 197   1          temperature = DS18B20_ReadTemp(); // è·å–æ¸©åº¦è®¡è½¬æ¢çš„æ¸©åº¦
 198   1          DS18B20_Convert();
 199   1          i = 35;
 200   1          do
 201   1          {
 202   2          } while (--i); // 85ä¸ªæœºå™¨å‘¨æœŸ å…±çº¦ 2+1+5815+70 ä¸ªæœºå™¨å‘¨æœŸ
 203   1          EA = 1; // å‡è®¾è§¦å‘å®šæ—¶ä¸­æ–­ 23 æ¬¡ å¯èƒ½æœ‰ä¸€äº›è¯¯å·® ä½†éå¸¸å°
 204   1          TR0 = 1;
 205   1          if (play_music)
 206   1              freqDelay -= 23;
 207   1          temperature *= 0.0625; // è½¬åŒ–ä¸ºå¯è¯»æ¸©åº¦
 208   1          // æ›´æ–°æ¸©åº¦æœ€å¤§æœ€å°å€¼
 209   1          if (temperature > highest)
 210   1              highest = temperature;
 211   1          if (temperature < lowest)
 212   1              lowest = temperature;
 213   1          // æ¯”è¾ƒæ¸©åº¦æ˜¯å¦è¶Šç•Œ å¹¶é‡‡å–æªæ–½
 214   1          if (temperature > upperLimit) // é«˜äºæ¸©åº¦ä¸Šé™
 215   1          {
 216   2              above_upper_limit = 1; // è®¾ç½®ä¸Šè¶Šç•Œæ ‡å¿—ä½
 217   2              dc_motor_working = 1;  // ç›´æµç”µæœºå¼€å§‹å·¥ä½œ
 218   2              fanGear = (temperature - upperLimit) / fanGearStep + 1;
 219   2              if (fanGear > 3)
 220   2                  fanGear = 3;
 221   2              i = 23;
 222   2              do
 223   2              {
 224   3                  AboveLimitClock(); // ä¸Šè¶Šç•Œå®šæ—¶
 225   3              } while (--i);
 226   2              if (!play_music)
 227   2                  init_music();
 228   2          }
 229   1          else if (temperature < lowerLimit) // ä½äºæ¸©åº¦ä¸‹é™
 230   1          {
 231   2              below_lower_limit = 1; // è®¾ç½®ä¸‹è¶Šç•Œæ ‡å¿—ä½
 232   2              RELAY = 1;             // é—­åˆç»§ç”µå™¨
 233   2              i = 21;
 234   2              do
 235   2              {
 236   3                  BelowLimitClock(); // ä¸‹è¶Šç•Œå®šæ—¶
 237   3              } while (--i);
 238   2              if (!play_music)
 239   2                  init_music();
 240   2          }
C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 5   

 241   1          else // æ¸©åº¦æ­£å¸¸
 242   1          {
 243   2              BUZZER = 1;
 244   2              RELAY = 0;             // æ–­å¼€ç»§ç”µå™¨
 245   2              dc_motor_working = 0;  // ç›´æµç”µæœºåœæ­¢å·¥ä½œ
 246   2              fanGear = 0;           // ç›´æµç”µæœºæ¡£ä½ç½®0
 247   2              below_lower_limit = 0; // ä¸‹è¶Šç•Œæ ‡å¿—ä½æ¸…0
 248   2              above_upper_limit = 0; // ä¸Šè¶Šç•Œæ ‡å¿—ä½æ¸…0
 249   2              PT0 = 1;
 250   2              TR1 = 0;
 251   2              play_music = 0;
 252   2          }
 253   1      }
 254          
 255          void UpdateViewPageShow(void)
 256          {
 257   1          switch (page) // åˆ¤æ–­å½“å‰å¤„äºå“ªä¸€ä¸ªè§†å›¾
 258   1          {
 259   2          case 0x7f: // ä¸»è§†å›¾ (æ¸©åº¦ä¿¡æ¯æŸ¥è¯¢è§†å›¾)
 260   2              if (page_change)
 261   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 262   3                  ShowViewPage_1();
 263   3                  page_change = 0;
 264   3              }
 265   2              // åˆ·æ–°æ¸©åº¦å€¼æ˜¾ç¤º
 266   2              LCD1602_WriteCmd(Move_Cursor_Row2_Col(2));
 267   2              FloatToString(temperature, numStr, 5, 1);
 268   2              LCD1602_ShowString(numStr);
 269   2              // åˆ·æ–°é£æ‰‡æ¡£ä½æ˜¾ç¤º
 270   2              LCD1602_WriteCmd(Move_Cursor_Row2_Col(15));
 271   2              Int8ToString(fanGear, numStr, 1);
 272   2              LCD1602_ShowString(numStr);
 273   2              break;
 274   2          case 0xbf: // æœ€é«˜/æœ€ä½æ¸©(æ¸©åº¦æå€¼)æŸ¥è¯¢è§†å›¾
 275   2              if (page_change)
 276   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 277   3                  ShowViewPage_2();
 278   3                  page_change = 0;
 279   3              }
 280   2              // åˆ·æ–°æ˜¾ç¤ºæ¸©åº¦çš„æå€¼
 281   2              LCD1602_WriteCmd(Move_Cursor_Row1_Col(9));
 282   2              UpdateExtremes(1);
 283   2              LCD1602_WriteCmd(Move_Cursor_Row2_Col(9));
 284   2              UpdateExtremes(0);
 285   2              break;
 286   2          case 0xdf: // æ¸©åº¦è¶Šç•Œè®¡æ—¶è§†å›¾
 287   2              if (page_change)
 288   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 289   3                  ShowViewPage_3();
 290   3                  page_change = 0;
 291   3              }
 292   2              // å¦‚æœæ¸©åº¦é«˜äºä¸Šé™ åˆ·æ–°æ˜¾ç¤ºä¸Šè¶Šç•Œè®¡æ—¶
 293   2              if (above_upper_limit)
 294   2              {
 295   3                  LCD1602_WriteCmd(Move_Cursor_Row1_Col(8));
 296   3                  UpdateOverLimitTimer(1);
 297   3              }
 298   2              // å¦‚æœæ¸©åº¦ä½äºä¸‹é™ åˆ·æ–°æ˜¾ç¤ºä¸‹è¶Šç•Œè®¡æ—¶
 299   2              else if (below_lower_limit)
 300   2              {
 301   3                  LCD1602_WriteCmd(Move_Cursor_Row2_Col(8));
 302   3                  UpdateOverLimitTimer(0);
C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 6   

 303   3              }
 304   2      
 305   2          case 0xef: // è®¾ç½®æŸ¥è¯¢è§†å›¾
 306   2              if (page_change)
 307   2              { // å¦‚æœè§†å›¾æ”¹å˜ åˆ·æ–°æ•´ä¸ªå±å¹•å†…å®¹æ˜¾ç¤º
 308   3                  ShowViewPage_4();
 309   3                  page_change = 0;
 310   3              }
 311   2              // æ²¡æœ‰éœ€è¦åˆ·æ–°çš„å¯å˜é‡
 312   2              break;
 313   2          }
 314   1      }
 315          
 316          void UpdateAboutTimer(void)
 317          {
 318   1          // æ ¹æ®åˆ†è¾¨ç‡è°ƒæ•´æ¸©åº¦è½¬æ¢éœ€è¦çš„æ—¶é—´
 319   1          if (!convert_finished && ++convertCount >= cttcn[dsr])
 320   1          {
 321   2              convertCount = 0;
 322   2              convert_finished = 1;
 323   2          }
 324   1          // å°†ç›´æµç”µæœºçš„æ–¹æ³¢åˆ†æˆ 3æ®µ æ ¹æ®æ¡£ä½å†³å®šæŸä¸€æ®µ ç”µå¹³é«˜ä½
 325   1          if (dc_motor_working)
 326   1          {
 327   2              if (++dcmCount >= 1440)       // 0.4s
 328   2                  if (dcmCount >= 2520)     // 0.7s
 329   2                      if (dcmCount >= 3600) // 1.0s
 330   2                          dcmCount = 0;
 331   2                      else // 0.7s - 1.0s
 332   2                          DCM = fanGear >= 0x03;
 333   2                  else // 0.4s - 0.7s
 334   2                      DCM = fanGear >= 0x02;
 335   2              else // 0.0s - 0.4s
 336   2                  DCM = fanGear >= 0x01;
 337   2          }
 338   1          else
 339   1              DCM = 0;
 340   1          // è¿‡ç•Œå®šæ—¶ éœ€è¦ 32ä¸ªæœºå™¨å‘¨æœŸ
 341   1          if (above_upper_limit)
 342   1              AboveLimitClock();
 343   1          else if (below_lower_limit)
 344   1              BelowLimitClock();
 345   1      
 346   1          if (play_music)
 347   1              if (--freqDelay == 96)
 348   1                  TR1 = 0;
 349   1              else if (!freqDelay)
 350   1              {
 351   2                  TR1 = 1;
 352   2                  if (musicArr[freqSelect] == 0xff)
 353   2                      freqSelect = 0;
 354   2                  freqH = FreqTable[musicArr[freqSelect]] >> 8;
 355   2                  freqL = FreqTable[musicArr[freqSelect]] & 0xff;
 356   2                  ++freqSelect;
 357   2                  freqDelay = freqSize * musicArr[freqSelect]; // é€‰æ‹©éŸ³ç¬¦å¯¹åº”çš„æ—¶é•¿
 358   2                  ++freqSelect;
 359   2              }
 360   1      }
 361          
 362          /**
 363           * X0 ä¸­æ–­å‡½æ•°
 364           * è®¾å®š:
C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 7   

 365           *     å¤–éƒ¨ä¸­æ–­0 ä¸ºä½ä¼˜å…ˆçº§ å¯ä»¥è¢«å®šæ—¶å™¨ä¸­æ–­ ç»™ä¸­æ–­
 366           *     å¦åˆ™ å¤–éƒ¨ä¸­æ–­ä¼šç ´å T0 äº§ç”Ÿçš„æ—¶åº
 367           *     è®¾ç½®æ¨¡å¼ä¸‹ä¼šå…³é—­å®šæ—¶å™¨ å› ä¸ºæ²¡æœ‰ç»§ç»­å®šæ—¶çš„å¿…è¦
 368           * æ€è·¯:
 369           *     å¤–éƒ¨ä¸­æ–­é€šè¿‡è½¯ä»¶å»¶è¿Ÿ æ¯0.05såˆ¤æ–­ä¸€æ¬¡æ˜¯å¦ä»ç„¶å¤„äº æŒ‰ä¸‹ä¸”ä»…æŒ‰ä¸‹ INT0
 370           çŠ¶æ€
 371           *     å½“æŒ‰ä¸‹æŒç»­æ—¶é—´è¶…è¿‡ç»™å®šé˜ˆå€¼å°†ä¼š åˆ‡æ¢è®¾ç½®/è§†å›¾æ¨¡å¼ å¹¶æ‰§è¡Œå¿…è¦çš„
 372           åˆå§‹åŒ–/æ”¶å°¾
 373           * å·¥ä½œ
 374           */
 375          void int_X0() interrupt 0
 376          {
 377   1          uchar ky; // ä¸´æ—¶ç”¨æ¥æ¥æ”¶æŒ‰é”®æ“ä½œ
 378   1          uchar i = 20;
 379   1          KEYS = 0xff;
 380   1          do
 381   1          {
 382   2              ky = 0x03;
 383   2              ky |= KEYS;
 384   2              if (ky != 0xfb)
 385   2              {
 386   3                  Delay1ms(10);
 387   3                  ky = 0x03;
 388   3                  ky |= KEYS;
 389   3                  if (ky != 0xfb)
 390   3                      return;
 391   3              }
 392   2              Delay1ms(50);
 393   2          } while (--i);
 394   1          if (settings_mode) // é€€å‡ºè®¾ç½®æ¨¡å¼
 395   1          {
 396   2              // å°†è®¾ç½®çš„å†…å®¹å­˜å‚¨è‡³ DS18B20
 397   2              DS18B20_Set(upperLimit, lowerLimit, dsr);
 398   2              DS18B20_Save();
 399   2              // å°†è®¾ç½®çš„å†…å®¹å­˜å‚¨è‡³ 24lc02
 400   2              settingsSave = 0xff;
 401   2              settingsSave &= (fanGearStep << 5) | (ringtoneNum << 3) | (ringRate);
 402   2              if (ringtone_change)
 403   2                  ReadMusic();
 404   2              /**
 405   2               * @bug ä¸çŸ¥é“ä¸ºä»€ä¹ˆ åªè¦åœ¨æ­¤æ”¾ä¸‹
 406   2               * AT24C02_WriteData(0xa0,0x00,&settingsSave,1) / Byte(...)
 407   2               * å°±ä¼šåœ¨è§¦å‘å¤–éƒ¨ä¸­æ–­æ—¶å¯¼è‡´æ­»å¾ªç¯/å´©æºƒï¼Œå“ªæ€• if(0)
 408   2               * æ²¡æœ‰è°ƒç”¨æ­¤å‡½æ•° ä»…ä»…æ˜¯å­˜åœ¨å°±ä¼šå¯¼è‡´å¦‚æ­¤ å› æ­¤ä½œä¸ºå¦¥å
 409   2               åªå¥½è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½
 410   2               * åœ¨ä¸»å¾ªç¯ä¸­è¿›è¡Œå­˜å‚¨
 411   2               */
 412   2              save_in_24c02 = 1;
 413   2              // ... ...
 414   2              DS18B20_Convert();
 415   2              convertCount = 0;
 416   2              convert_finished = 0; // é‡æ–°æ‰“å¼€æ¸©åº¦è½¬æ¢
 417   2              TR0 = 1;              // é‡å¯å®šæ—¶å™¨å¼€å§‹æµ‹æ¸©
 418   2              ET0 = 1;
 419   2              freqSize = 2144 - 256 * ringRate;
 420   2              option = 0xff;   // è®¾ç½®æ¨¡å¼ ä¸é€‰æ‹©
 421   2              page_change = 1; // éœ€è¦åˆ·æ–°æ•´ä¸ªè§†å›¾æ˜¾ç¤º
 422   2          }
 423   1          else // è¿›å…¥è®¾ç½®æ¨¡å¼
 424   1          {
 425   2              ET0 = 0;
 426   2              TR0 = 0;        // å…³é—­å®šæ—¶è®¡å™¨T0
C51 COMPILER V9.60.7.0   MAIN                                                              12/08/2023 09:18:20 PAGE 8   

 427   2              TR1 = 0;        // å…³é—­å®šæ—¶è®¡å™¨T1
 428   2              BUZZER = 1;     // å…³é—­èœ‚é¸£å™¨
 429   2              RELAY = 0;      // æ–­å¼€ç»§ç”µå™¨
 430   2              DCM = 0;        // å…³é—­ç›´æµç”µæœº
 431   2              play_music = 0; // å…³é—­éŸ³ä¹
 432   2              // å¾—ä»ä¸»å‡½æ•°ä¸­è°ƒç”¨ å¦åˆ™å¯èƒ½ä¼šå‘ç”Ÿå½¢å‚è¢«å‡ºé”™ äº§ç”Ÿä¸å¯é¢„æ–™é—®é¢˜
 433   2              // å¯ä»¥è®¾å®šä¸€ä¸ªæ ‡å¿— è®©ä¸»å‡½æ•°è°ƒç”¨ä¸€æ¬¡ ready_settings
 434   2              ready_settings = 1; // è¿›å…¥è®¾ç½®æ¨¡å¼ åˆ·æ–°è®¾ç½®æ¨¡å¼æ˜¾ç¤º
 435   2          }
 436   1          settings_mode = !settings_mode;
 437   1      }
 438          
 439          /**
 440           * T0 ä¸­æ–­å‡½æ•°
 441           * è®¾å®š:
 442           *     å®šæ—¶å™¨ T0 æ–¹å¼2 åˆå€¼ 0 è®¡æ•°256æº¢å‡ºä¸€æ¬¡
 443           *     æ‰€ä»¥ å®šæ—¶å™¨ä¸­æ–­å†… æŒ‡ä»¤å‘¨æœŸæ€»å’Œéœ€è¦å°‘äº 250 ä¸ªæœºå™¨å‘¨æœŸ
 444           *     åœ¨ å®šæ—¶å™¨ä¸­æ–­å‡½æ•°å†… è·å–æ¸©åº¦ç­‰å¤æ‚å‡½æ•° ä¼šä¸¥é‡ç ´å T0 äº§ç”Ÿçš„æ—¶åº
 445           * æ€è·¯:
 446           *     åœ¨ä¸­æ–­å‡½æ•°å†…é€šè¿‡è®¾ç½®æ ‡å¿—ä½ è®©å¤æ‚çš„å‡½æ•°é€»è¾‘åœ¨ä¸»å¾ªç¯ä¸­æ‰§è¡Œ
 447           * ç†å¿µ:
 448           *     åœ¨ 11.0592MHzä¸‹  æ¯ 1/3.6 ms æº¢å‡ºä¸€æ¬¡ å³ä¸­æ–­36æ¬¡ä¸º 10ms
 449           *     æ‰€ä»¥ T0 å¯ä»¥ä½œä¸º 1/3.6 ms çš„æ—¶åºäº§ç”Ÿå™¨
 450           *     é€šè¿‡ è®¡æ•°å˜é‡ count å³å¯å®ç°ä¸åŒå‘¨æœŸçš„å®šæ—¶
 451           */
 452          void int_T0() interrupt 1 using 1 // æŒ‡å®šå¯„å­˜å™¨ç»„æé«˜ç¨‹åºæ•ˆç‡ å‡å°‘è¯¯å·®
 453          {
 454   1          UpdateAboutTimer();
 455   1      }
 456          
 457          void int_T1() interrupt 3 using 2 // æŒ‡å®šå¯„å­˜å™¨ç»„æé«˜ç¨‹åºæ•ˆç‡ å‡å°‘è¯¯å·®
 458          {
 459   1          if (freqH || freqL) // å¦‚æœæ˜¯ä¼‘æ­¢ç¬¦(0)ï¼Œé‚£ä¹ˆä¸æ’­æ”¾å£°éŸ³ï¼Œåªè¿›è¡Œå»¶æ—¶
 460   1          {
 461   2              // å–å¯¹åº”é¢‘ç‡å€¼çš„é‡è£…è½½å€¼åˆ°å®šæ—¶å™¨(ç¡®è®¤éŸ³é«˜) musicArr[musicSelect]
 462   2              TH1 = freqH; // è®¾ç½®é«˜ä½å®šæ—¶åˆå€¼
 463   2              TL1 = freqL; // è®¾ç½®ä½ä½å®šæ—¶åˆå€¼
 464   2              // ç¿»è½¬èœ‚é¸£å™¨IOå£(æ³¨æ„è¿™é‡Œçš„é‡è£…å€¼æ˜¯å‘¨æœŸçš„ä¸€åŠï¼Œæ•…ä»…è¿›è¡Œä¸€æ¬¡èœ‚é¸£å™¨çš
             -„ç¿»è½¬)
 465   2              BUZZER = !BUZZER;
 466   2          }
 467   1          if (TF0)
 468   1          {
 469   2              TF0 = 0;
 470   2              UpdateAboutTimer();
 471   2          }
 472   1      }
 473          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1295    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
